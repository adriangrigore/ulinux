#!/bin/sh

tmpc=

cleanup() {
  umount "$tmpc"/root/tmp
  umount "$tmpc"/root/dev
  umount "$tmpc"/root
  rm -rf "$tmpc"
}

setup_rootfs() {
  mkdir -p "$tmpc"/root "$tmpc"/storage "$tmpc"/work
  mount -t overlay -o upperdir="$tmpc/storage,lowerdir=/,workdir=$tmpc/work" overlayfs "$tmpc/root"
  mount --bind /dev "$tmpc"/root/dev
  mount --bind /tmp "$tmpc"/root/tmp
}

create_tmpc() {
  tmpc="$(mktemp -d)"
  trap cleanup EXIT
}

_main() {
  create_tmpc
  setup_rootfs

  unshare \
    --ipc \
    --uts \
    --pid \
    --user \
    --fork \
    --mount \
    --mount-proc \
    --map-root-user \
    sh -c "mount -t proc proc $tmpc/root/proc; chroot $tmpc/root $*"
}

if [ -n "$0" ] && [ x"$0" != x"-bash" ]; then
  _main "$@"
fi
